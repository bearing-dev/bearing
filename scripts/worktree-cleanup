#!/bin/bash
set -e

# Remove a worktree after merge
# Usage: worktree-cleanup <repo> <branch>

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
SAILKIT_DIR="$(dirname "$SCRIPT_DIR")"
PROJECTS_DIR="$(dirname "$SAILKIT_DIR")"
MANIFEST="$SAILKIT_DIR/manifest.jsonl"

if [ $# -lt 2 ]; then
    echo "Usage: worktree-cleanup <repo> <branch>"
    echo "Example: worktree-cleanup fightingwithai.com feature-branch"
    exit 1
fi

REPO="$1"
BRANCH="$2"
REPO_DIR="$PROJECTS_DIR/$REPO"
WORKTREE_DIR="$PROJECTS_DIR/$REPO-$BRANCH"
FOLDER_NAME="$REPO-$BRANCH"

if [ ! -d "$WORKTREE_DIR" ]; then
    echo "Error: Worktree not found: $WORKTREE_DIR"
    exit 1
fi

echo "Removing worktree: $WORKTREE_DIR"
git -C "$REPO_DIR" worktree remove "$WORKTREE_DIR"

# Remove from manifest (filter out matching folder)
if [ -f "$MANIFEST" ]; then
    grep -v "\"folder\":\"$FOLDER_NAME\"" "$MANIFEST" > "$MANIFEST.tmp" || true
    mv "$MANIFEST.tmp" "$MANIFEST"
    echo "Manifest updated: removed $FOLDER_NAME"
fi

echo "Done."
