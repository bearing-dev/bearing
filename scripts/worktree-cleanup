#!/bin/bash
set -e

# Remove a worktree after merge
# Usage: worktree-cleanup <repo> <branch>

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
SAILKIT_DIR="$(dirname "$SCRIPT_DIR")"
WORKSPACE_DIR="$(dirname "$SAILKIT_DIR")"
WORKFLOW_FILE="$WORKSPACE_DIR/workflow.jsonl"
LOCAL_FILE="$WORKSPACE_DIR/local.jsonl"

if [ $# -lt 2 ]; then
    echo "Usage: worktree-cleanup <repo> <branch>"
    echo "Example: worktree-cleanup fightingwithai.com feature-branch"
    exit 1
fi

REPO="$1"
BRANCH="$2"
REPO_DIR="$WORKSPACE_DIR/$REPO"
WORKTREE_DIR="$WORKSPACE_DIR/$REPO-$BRANCH"
FOLDER_NAME="$REPO-$BRANCH"

if [ ! -d "$WORKTREE_DIR" ]; then
    echo "Error: Worktree not found: $WORKTREE_DIR"
    exit 1
fi

echo "Removing worktree: $WORKTREE_DIR"
git -C "$REPO_DIR" worktree remove "$WORKTREE_DIR"

# Update workflow.jsonl - mark as completed (keep for history)
if [ -f "$WORKFLOW_FILE" ]; then
    # Replace status with "completed" for this branch
    sed -i '' "s/\"repo\":\"$REPO\",\"branch\":\"$BRANCH\",\(.*\)\"status\":\"in_progress\"/\"repo\":\"$REPO\",\"branch\":\"$BRANCH\",\1\"status\":\"completed\"/" "$WORKFLOW_FILE" 2>/dev/null || \
    sed -i "s/\"repo\":\"$REPO\",\"branch\":\"$BRANCH\",\(.*\)\"status\":\"in_progress\"/\"repo\":\"$REPO\",\"branch\":\"$BRANCH\",\1\"status\":\"completed\"/" "$WORKFLOW_FILE"
    echo "Workflow updated: marked $BRANCH as completed"
fi

# Remove from local.jsonl
if [ -f "$LOCAL_FILE" ]; then
    grep -v "\"folder\":\"$FOLDER_NAME\"" "$LOCAL_FILE" > "$LOCAL_FILE.tmp" || true
    mv "$LOCAL_FILE.tmp" "$LOCAL_FILE"
    echo "Local state updated: removed $FOLDER_NAME"
fi

echo "Done."
