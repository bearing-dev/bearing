#!/bin/bash
set -e

# Register an existing folder as a base repo in the manifest
# Usage: worktree-register <folder>

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
SAILKIT_DIR="$(dirname "$SCRIPT_DIR")"
PROJECTS_DIR="$(dirname "$SAILKIT_DIR")"
MANIFEST="$SAILKIT_DIR/manifest.jsonl"

if [ $# -lt 1 ]; then
    echo "Usage: worktree-register <folder>"
    echo "Example: worktree-register fightingwithai.com"
    exit 1
fi

FOLDER="$1"
FOLDER_PATH="$PROJECTS_DIR/$FOLDER"

if [ ! -d "$FOLDER_PATH" ]; then
    echo "Error: Folder not found: $FOLDER_PATH"
    exit 1
fi

if [ ! -d "$FOLDER_PATH/.git" ]; then
    echo "Error: $FOLDER_PATH is not a git repository (no .git directory)"
    exit 1
fi

# Check if already registered
if [ -f "$MANIFEST" ] && grep -q "\"folder\":\"$FOLDER\"" "$MANIFEST"; then
    echo "Error: $FOLDER is already registered in manifest"
    exit 1
fi

branch=$(git -C "$FOLDER_PATH" rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")
created=$(stat -f "%Sm" -t "%Y-%m-%dT%H:%M:%SZ" "$FOLDER_PATH" 2>/dev/null || echo "unknown")

ENTRY="{\"folder\":\"$FOLDER\",\"repo\":\"$FOLDER\",\"branch\":\"$branch\",\"base\":true,\"created\":\"$created\"}"
echo "$ENTRY" >> "$MANIFEST"

echo "Registered $FOLDER as base repo (branch: $branch)"
