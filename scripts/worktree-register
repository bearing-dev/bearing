#!/bin/bash
set -e

# Register an existing folder as a base repo
# Usage: worktree-register <folder>

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
SAILKIT_DIR="$(dirname "$SCRIPT_DIR")"
WORKSPACE_DIR="$(dirname "$SAILKIT_DIR")"
LOCAL_FILE="$WORKSPACE_DIR/local.jsonl"

if [ $# -lt 1 ]; then
    echo "Usage: worktree-register <folder>"
    echo "Example: worktree-register fightingwithai.com"
    exit 1
fi

FOLDER="$1"
FOLDER_PATH="$WORKSPACE_DIR/$FOLDER"

if [ ! -d "$FOLDER_PATH" ]; then
    echo "Error: Folder not found: $FOLDER_PATH"
    exit 1
fi

if [ ! -d "$FOLDER_PATH/.git" ]; then
    echo "Error: $FOLDER_PATH is not a git repository (no .git directory)"
    exit 1
fi

# Check if already registered
if [ -f "$LOCAL_FILE" ] && grep -q "\"folder\":\"$FOLDER\"" "$LOCAL_FILE"; then
    echo "Error: $FOLDER is already registered"
    exit 1
fi

branch=$(git -C "$FOLDER_PATH" rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")

ENTRY="{\"folder\":\"$FOLDER\",\"repo\":\"$FOLDER\",\"branch\":\"$branch\",\"base\":true}"
echo "$ENTRY" >> "$LOCAL_FILE"

echo "Registered $FOLDER as base repo (branch: $branch)"
