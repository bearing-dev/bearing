#!/bin/bash

# Display workflow and local state as ASCII tables
# Usage: worktree-list [--local | --workflow]

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
SAILKIT_DIR="$(dirname "$SCRIPT_DIR")"
WORKSPACE_DIR="$(dirname "$SAILKIT_DIR")"
WORKFLOW_FILE="$WORKSPACE_DIR/workflow.jsonl"
LOCAL_FILE="$WORKSPACE_DIR/local.jsonl"

SHOW_LOCAL=true
SHOW_WORKFLOW=true

if [ "$1" = "--local" ]; then
    SHOW_WORKFLOW=false
elif [ "$1" = "--workflow" ]; then
    SHOW_LOCAL=false
fi

# Show local state (worktrees on this machine)
if [ "$SHOW_LOCAL" = true ]; then
    echo "=== Local Worktrees ==="
    echo ""
    if [ ! -f "$LOCAL_FILE" ] || [ ! -s "$LOCAL_FILE" ]; then
        echo "No local worktrees. Run worktree-sync to scan."
    else
        printf "%-40s %-25s %-20s %-6s\n" "FOLDER" "REPO" "BRANCH" "BASE"
        printf "%-40s %-25s %-20s %-6s\n" "------" "----" "------" "----"

        while IFS= read -r line; do
            folder=$(echo "$line" | sed -n 's/.*"folder":"\([^"]*\)".*/\1/p')
            repo=$(echo "$line" | sed -n 's/.*"repo":"\([^"]*\)".*/\1/p')
            branch=$(echo "$line" | sed -n 's/.*"branch":"\([^"]*\)".*/\1/p')
            base=$(echo "$line" | sed -n 's/.*"base":\([^,}]*\).*/\1/p')

            [ "$base" = "true" ] && base_display="yes" || base_display="no"
            printf "%-40s %-25s %-20s %-6s\n" "$folder" "$repo" "$branch" "$base_display"
        done < "$LOCAL_FILE"
    fi
    echo ""
fi

# Show workflow state (all branches, shareable)
if [ "$SHOW_WORKFLOW" = true ]; then
    echo "=== Workflow (Branches) ==="
    echo ""
    if [ ! -f "$WORKFLOW_FILE" ] || [ ! -s "$WORKFLOW_FILE" ]; then
        echo "No workflow entries. Create worktrees with worktree-new."
    else
        printf "%-25s %-25s %-15s %-12s %-30s\n" "REPO" "BRANCH" "BASED_ON" "STATUS" "PURPOSE"
        printf "%-25s %-25s %-15s %-12s %-30s\n" "----" "------" "--------" "------" "-------"

        while IFS= read -r line; do
            repo=$(echo "$line" | sed -n 's/.*"repo":"\([^"]*\)".*/\1/p')
            branch=$(echo "$line" | sed -n 's/.*"branch":"\([^"]*\)".*/\1/p')
            basedOn=$(echo "$line" | sed -n 's/.*"basedOn":"\([^"]*\)".*/\1/p')
            status=$(echo "$line" | sed -n 's/.*"status":"\([^"]*\)".*/\1/p')
            purpose=$(echo "$line" | sed -n 's/.*"purpose":"\([^"]*\)".*/\1/p')

            # Truncate purpose if too long
            [ ${#purpose} -gt 28 ] && purpose="${purpose:0:25}..."

            printf "%-25s %-25s %-15s %-12s %-30s\n" "$repo" "$branch" "$basedOn" "$status" "$purpose"
        done < "$WORKFLOW_FILE"
    fi
fi
