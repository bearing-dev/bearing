#!/bin/bash
set -e

# Rebuild manifest.jsonl from actual git worktree state
# Usage: worktree-sync

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
SAILKIT_DIR="$(dirname "$SCRIPT_DIR")"
PROJECTS_DIR="$(dirname "$SAILKIT_DIR")"
MANIFEST="$SAILKIT_DIR/manifest.jsonl"

echo "Scanning for worktrees in: $PROJECTS_DIR"

# Start fresh manifest
> "$MANIFEST"

# Find all git repos (look for .git directory, not .git file which indicates worktree)
for repo_dir in "$PROJECTS_DIR"/*/; do
    repo_name=$(basename "$repo_dir")

    # Skip sailkit-dev itself
    [ "$repo_name" = "sailkit-dev" ] && continue

    # Check if it's a base git repo (has .git directory, not file)
    if [ -d "$repo_dir/.git" ]; then
        # This is a base repo
        branch=$(git -C "$repo_dir" rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")
        created=$(stat -f "%Sm" -t "%Y-%m-%dT%H:%M:%SZ" "$repo_dir" 2>/dev/null || echo "unknown")

        echo "{\"folder\":\"$repo_name\",\"repo\":\"$repo_name\",\"branch\":\"$branch\",\"base\":true,\"created\":\"$created\"}" >> "$MANIFEST"

        # List worktrees for this repo
        while IFS= read -r line; do
            wt_path=$(echo "$line" | cut -d' ' -f1)
            wt_name=$(basename "$wt_path")

            # Skip the main worktree (same as repo)
            [ "$wt_name" = "$repo_name" ] && continue

            # Extract branch from worktree
            wt_branch=$(git -C "$wt_path" rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")
            wt_created=$(stat -f "%Sm" -t "%Y-%m-%dT%H:%M:%SZ" "$wt_path" 2>/dev/null || echo "unknown")

            echo "{\"folder\":\"$wt_name\",\"repo\":\"$repo_name\",\"branch\":\"$wt_branch\",\"base\":false,\"basedOn\":\"unknown\",\"created\":\"$wt_created\"}" >> "$MANIFEST"
        done < <(git -C "$repo_dir" worktree list 2>/dev/null | tail -n +2)
    fi
done

echo "Manifest updated: $MANIFEST"
echo ""
"$SCRIPT_DIR/worktree-list"
