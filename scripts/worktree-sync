#!/bin/bash
set -e

# Rebuild state files from actual git worktree state
# Usage: worktree-sync

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
SAILKIT_DIR="$(dirname "$SCRIPT_DIR")"
WORKSPACE_DIR="$(dirname "$SAILKIT_DIR")"
WORKFLOW_FILE="$WORKSPACE_DIR/workflow.jsonl"
LOCAL_FILE="$WORKSPACE_DIR/local.jsonl"
CONFIG_FILE="$WORKSPACE_DIR/.sailkit.yaml"

echo "Scanning for worktrees in: $WORKSPACE_DIR"

# Start fresh local state (worktrees are purely local)
> "$LOCAL_FILE"

# Preserve existing workflow entries, we'll add new ones
EXISTING_WORKFLOW=""
if [ -f "$WORKFLOW_FILE" ]; then
    EXISTING_WORKFLOW=$(cat "$WORKFLOW_FILE")
fi
> "$WORKFLOW_FILE"

# Find all git repos
for repo_dir in "$WORKSPACE_DIR"/*/; do
    repo_name=$(basename "$repo_dir")

    # Skip sailkit-dev itself
    [ "$repo_name" = "sailkit-dev" ] && continue

    # Check if it's a base git repo (has .git directory, not file)
    if [ -d "$repo_dir/.git" ]; then
        branch=$(git -C "$repo_dir" rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")

        # Add base repo to local.jsonl
        echo "{\"folder\":\"$repo_name\",\"repo\":\"$repo_name\",\"branch\":\"$branch\",\"base\":true}" >> "$LOCAL_FILE"

        # List worktrees for this repo
        while IFS= read -r line; do
            wt_path=$(echo "$line" | cut -d' ' -f1)
            wt_name=$(basename "$wt_path")

            # Skip the main worktree
            [ "$wt_name" = "$repo_name" ] && continue

            wt_branch=$(git -C "$wt_path" rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")

            # Add to local.jsonl
            echo "{\"folder\":\"$wt_name\",\"repo\":\"$repo_name\",\"branch\":\"$wt_branch\",\"base\":false}" >> "$LOCAL_FILE"

            # Check if workflow entry exists, if not create one
            if ! echo "$EXISTING_WORKFLOW" | grep -q "\"repo\":\"$repo_name\",\"branch\":\"$wt_branch\""; then
                echo "{\"repo\":\"$repo_name\",\"branch\":\"$wt_branch\",\"basedOn\":\"unknown\",\"purpose\":\"\",\"status\":\"in_progress\",\"created\":\"unknown\"}" >> "$WORKFLOW_FILE"
            fi
        done < <(git -C "$repo_dir" worktree list 2>/dev/null | tail -n +2)
    fi
done

# Re-add existing workflow entries
if [ -n "$EXISTING_WORKFLOW" ]; then
    echo "$EXISTING_WORKFLOW" >> "$WORKFLOW_FILE"
    # Deduplicate by repo+branch (keep first occurrence)
    sort -u -t',' -k1,2 "$WORKFLOW_FILE" > "$WORKFLOW_FILE.tmp" 2>/dev/null || cat "$WORKFLOW_FILE" > "$WORKFLOW_FILE.tmp"
    mv "$WORKFLOW_FILE.tmp" "$WORKFLOW_FILE"
fi

echo "State updated:"
echo "  workflow.jsonl: $(wc -l < "$WORKFLOW_FILE" | tr -d ' ') branches"
echo "  local.jsonl: $(wc -l < "$LOCAL_FILE" | tr -d ' ') folders"
echo ""
"$SCRIPT_DIR/worktree-list"
